<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Log Analyzer</title>
  <link
    href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
    rel="stylesheet"
  />
  <style>
    body { font-family: Arial, sans-serif; }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 10px;
      align-items: center;
    }
    .metrics-summary {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    .serial-number-column { width: 60px; }
    .radio-group { display: flex; gap: 10px; }
    .tags-dropdown { width: 180px; }
    .select2-container { min-width: 180px; max-width: 300px; }
    .pagination { margin: 15px 0; }
    .pagination a, .pagination span {
      margin: 0 5px;
      text-decoration: none;
      font-weight: bold;
    }
    .pagination a { color: blue; }
    .pagination .current-page { color: red; }
    #breakdown {
      height: 150px;
      overflow-y: auto;
      column-width: 45ch;
      column-gap: 5px;
      border: 1px solid #ccc;
      padding: 5px;
      margin-bottom: 20px;
    }
    .query-column {
      width: 300px;
      max-width: 300px;
      word-wrap: break-word;
      white-space: normal;
    }
    .response-column h1,
    .response-column h2,
    .response-column h3,
    .response-column h4,
    .response-column h5,
    .response-column h6 {
      font-size: 1rem;
      margin: 0.5em 0;
    }

    .response-column p {
      margin: 0.5em 0; /* reduce space between paragraphs */
    }

    .response-column pre,
    .response-column code {
      font-family: monospace;
      background-color: #f4f4f4;
      padding: 0.5em;
      border-radius: 4px;
      display: block;
      overflow-x: auto;
      white-space: pre-wrap;
    }

   .response-column {
     font-family: sans-serif;
     line-height: 1.4;
     white-space: normal;
    }
   
    .read-only {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .read-only-banner {
      background-color: #ffdddd;
      border: 1px solid #ffaaaa;
      padding: 10px;
      margin-bottom: 15px;
      text-align: center;
      font-weight: bold;
      color: #a00;
    }
  /* --- Collapse Response --- */
  .response-preview {
    display: -webkit-box;
    -webkit-line-clamp: 4;         /* change to 2,3,4 lines if you want */
    -webkit-box-orient: vertical;
    overflow: hidden;
    white-space: normal;
  }

  .response-toggle {
    margin-top: 6px;
    padding: 0;
    border: none;
    background: none;
    color: #0b62d6;
    cursor: pointer;
    font-weight: 600;
  }

.response-full[hidden] { display: none; }

/* --- Make dropdown controls look compact in table --- */
.compact-select {
  min-width: 140px;
  padding: 4px;
}

/* --- Stat cards --- */
.stat-cards {
  display: flex;
  gap: 15px;
  margin-bottom: 10px;
}
.stat-card {
  border: 1px solid #ccc;
  border-radius: 6px;
  padding: 12px 20px;
  text-align: center;
  min-width: 110px;
  background: #fafafa;
}
.stat-card .stat-value {
  font-size: 2rem;
  font-weight: bold;
}
.stat-card .stat-label {
  font-size: 0.82rem;
  color: #555;
  margin-top: 4px;
}

  </style>
</head>
<body>
  <h1>Log Analyzer</h1>
  <div style="float: right; margin-top: -40px;">
    <span>Logged in as: <strong>{{ session['user_id'] }}</strong></span>
    &nbsp;|&nbsp;
    <a href="{{ url_for('auth.logout') }}">Logout</a>
  </div>
  {% if read_only %}
    <div class="read-only-banner">
      You are logged in as a read-only user. No changes to the database are permitted.
    </div>
  {% endif %}

  <form id="filter-form" method="GET" action="/">
    <div class="form-row">
      <div>
        Start Date:
        <input type="date" name="start_date" value="{{ start_date }}">
      </div>
      <div>
        End Date:
        <input type="date" name="end_date" value="{{ end_date }}">
      </div>
    </div>

    <div class="form-row">
      <div>
        <label for="tool_filter">Tool</label>
        <select name="tool" id="tool_filter">
          {% for option in tool_options %}
            <option value="{{ option }}" {% if option==selected_tool %}selected{% endif %}>{{ option }}</option>
          {% endfor %}
        </select>
        <label for="independent_filter">Independent?</label>
        <select name="independent" id="independent_filter">
          {% for option in is_independent_options %}
            <option value="{{ option }}" {% if option==selected_independent %}selected{% endif %}>{{ option }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="response_review_filter">AI Response Review:</label>
        <select name="response_review" id="response_review_filter" multiple>
          {% for opt in response_review_options %}
            <option value="{{ opt }}" {% if opt in selected_response_review %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="query_review_filter">User Query Review:</label>
        <select name="query_review" id="query_review_filter" multiple>
          {% for opt in query_review_options %}
            <option value="{{ opt }}" {% if opt in selected_query_review %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="urls_review_filter">URLs Review:</label>
        <select name="urls_review" id="urls_review_filter" multiple>
          {% for opt in urls_review_options %}
            <option value="{{ opt }}" {% if opt in selected_urls_review %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="review_status_filter">Review Status:</label>
        <select name="review_status" id="review_status_filter">
          {% for option in review_status_options %}
            <option value="{{ option }}" {% if option==selected_review_status %}selected{% endif %}>{{ option }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="form-row">
      <button type="button" id="reset-filters">Clear</button>
      <button type="submit">Apply</button>
    </div>

	
<!--  <div class="form-row">
      <div>
        <label>Download as:</label>
        <label><input type="radio" name="download_type" value="csv" checked> CSV</label>
        <label><input type="radio" name="download_type" value="xls"> XLS</label>
        <button type="button" id="download-all">Download All</button>
      </div>
    </div> -->
  </form>

  {{ filter_summary_message|safe }}

  <div id="metrics-summary" class="metrics-summary">
    <div class="stat-cards">
      <div class="stat-card">
        <div class="stat-value">{{ review_counts.total }}</div>
        <div class="stat-label">Total Queries</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ review_counts.reviewed }}</div>
        <div class="stat-label">Reviewed</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ review_counts.not_reviewed }}</div>
        <div class="stat-label">Not Reviewed</div>
      </div>
    </div>
    <details>
      <summary style="cursor:pointer; color:#0b62d6; font-weight:600;">Breakdown</summary>
      <div id="breakdown">
        {% for line in metrics_text %}
          <div>{{ line }}</div>
        {% endfor %}
      </div>
    </details>
  </div>

  <!-- Top pagination -->
  <div class="pagination">
    {% if prev_page %}
      <a href="?page=1{{ param_str }}">First</a>
      <a href="?page={{ prev_page }}{{ param_str }}">Previous</a>
    {% endif %}
    {% for p in range(1, total_pages+1) %}
      {% if p==page %}
        <span class="current-page">{{ p }}</span>
      {% else %}
        <a href="?page={{ p }}{{ param_str }}">{{ p }}</a>
      {% endif %}
    {% endfor %}
    {% if next_page %}
      <a href="?page={{ next_page }}{{ param_str }}">Next</a>
      <a href="?page={{ total_pages }}{{ param_str }}">Last</a>
    {% endif %}
  </div>

  <div style="margin: 10px 0;">
    <label>View By:
      <select name="view_by" form="filter-form">
        <option value="daily"   {% if view_by=='daily'  %}selected{% endif %}>Daily</option>
        <option value="weekly"  {% if view_by=='weekly' %}selected{% endif %}>Weekly</option>
        <option value="monthly" {% if view_by=='monthly'%}selected{% endif %}>Monthly</option>
      </select>
    </label>
  </div>

  <div id="graph-container">
    {{ graph_html|safe }}
  </div>

  <div class="button-container">
    <button id="update-table" class="btn btn-primary">Update Logs</button>
  </div>

  <table id="logs-table">
    <thead>
      <tr>
        <th class="serial-number-column">#</th>
        <th>Timestamp</th>
        <th class="query-column">Query</th>
        <th class="response-column">Response</th>
        <th>Tool</th>
        <th>Tester</th>
        <th>Independent?</th>
        <th>AI Response Review</th>
        <th>User Query Review</th>
        <th>URLs Review</th>
        <th>Notes</th>
        <th>Last Updated At</th>
	      <th>Last Updated By</th>
      </tr>
    </thead>
    <tbody id="logs-table-body">
      {% if not logs %}
      <tr>
        <td colspan="13" style="text-align:center; padding:20px; color:#666;">
          No entries found for the selected date range and filters.
        </td>
      </tr>
      {% else %}
      {% for log in logs %}
      <tr data-log-id="{{ log.id }}">
        <td>{{ (page-1)*10 + loop.index }}</td>
        <td>{{ log.timestamp }}</td>
        <td class="query-column">{{ log.query }}</td>
        <td class="response-column">
          <div class="response-preview"></div>
          <button type="button" class="response-toggle">Expand</button>
          <div class="response-full" hidden>{{ log.response|safe }}</div>
        </td>
        <td>{{ log.tool }}</td>
        <td>{{ log.tester }}</td>
    
          <td>
            <select name="is_independent_{{ log.id }}" class="compact-select" {% if read_only %}disabled{% endif %}>
              <option value="">—</option>
              <option value="Yes" {% if log.is_independent_question=='Yes' %}selected{% endif %}>Yes</option>
              <option value="No"  {% if log.is_independent_question=='No'  %}selected{% endif %}>No</option>
            </select>
          </td>

        
        
          <td>
            <select name="response_review_{{ log.id }}" class="compact-select" {% if read_only %}disabled{% endif %}>
              <option value="">—</option>
              <option value="Excellent" {% if log.response_review=='Excellent' %}selected{% endif %}>Excellent</option>
              <option value="Good" {% if log.response_review=='Good' %}selected{% endif %}>Good</option>
              <option value="Satisfactory" {% if log.response_review=='Satisfactory' %}selected{% endif %}>Satisfactory</option>
              <option value="Unsatisfactory" {% if log.response_review=='Unsatisfactory' %}selected{% endif %}>Unsatisfactory</option>
              <option value="Not Sure" {% if log.response_review=='Not Sure' %}selected{% endif %}>Not Sure</option>
            </select>
          </td>

        
        
          <td>
            <select name="query_review_{{ log.id }}" class="compact-select" {% if read_only %}disabled{% endif %}>
              <option value="">—</option>
              <option value="Relevant" {% if log.query_review=='Relevant' %}selected{% endif %}>Relevant</option>
              <option value="Irrelevant" {% if log.query_review=='Irrelevant' %}selected{% endif %}>Irrelevant</option>
              <option value="Violation" {% if log.query_review=='Violation' %}selected{% endif %}>Violation</option>
              <option value="Badly Formed" {% if log.query_review=='Badly Formed' %}selected{% endif %}>Badly Formed</option>
              <option value="Not Sure" {% if log.query_review=='Not Sure' %}selected{% endif %}>Not Sure</option>
            </select>
          </td>

        
        
          <td>
            <select name="urls_review_{{ log.id }}" class="compact-select" {% if read_only %}disabled{% endif %}>
              <option value="">—</option>
              <option value="Good" {% if log.urls_review=='Good' %}selected{% endif %}>Good</option>
              <option value="Acceptable" {% if log.urls_review=='Acceptable' %}selected{% endif %}>Acceptable</option>
              <option value="Bad" {% if log.urls_review=='Bad' %}selected{% endif %}>Bad</option>
              <option value="I Don't Know" {% if log.urls_review=="I Don't Know" %}selected{% endif %}>I Don't Know</option>
            </select>
          </td>
        
  <!-- New NOTES column -->
  <td>
      <textarea class="notes-input"
                rows="2"
                style="width: 220px;"
                {% if read_only %}disabled{% endif %}>{{ log.notes or '' }}</textarea>
  </td>
	<td class="last-updated-at">{{ log.last_updated_at or '-' }}</td>
  <td class="last-updated-by">{{ log.last_updated_by or '-' }}</td>

      </tr>
      {% endfor %}
      {% endif %}
    </tbody>
  </table>

  <!-- Bottom pagination -->
  <div class="pagination" id="pagination-controls">
    {% if prev_page %}
      <a href="?page=1{{ param_str }}">First</a>
      <a href="?page={{ prev_page }}{{ param_str }}">Previous</a>
    {% endif %}
    {% for p in range(1, total_pages+1) %}
      {% if p==page %}
        <span class="current-page">{{ p }}</span>
      {% else %}
        <a href="?page={{ p }}{{ param_str }}">{{ p }}</a>
      {% endif %}
    {% endfor %}
    {% if next_page %}
      <a href="?page={{ next_page }}{{ param_str }}">Next</a>
      <a href="?page={{ total_pages }}{{ param_str }}">Last</a>
    {% endif %}
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist@2.14.0"></script>
  <script>
    $.ajaxSetup({ traditional: true });

    function getCurrentFilters() {
      return {
        start_date: $('input[name="start_date"]').val(),
        end_date:   $('input[name="end_date"]').val(),
        view_by:    $('select[name="view_by"]').val(),
        tool:       $('#tool_filter').val() || "All",
        independent: $('#independent_filter').val() || "All",
        response_review: $('#response_review_filter').val() || [],
        query_review:    $('#query_review_filter').val() || [],
        urls_review:     $('#urls_review_filter').val() || [],
        review_status:   $('#review_status_filter').val() || "All"
      };
    }
    
//     function updateGraph() {
//   const graphContainer = document.getElementById("graph-container");

//   // 1. Get current filters
//   const filters = getCurrentFilters();  // You already have this function

//   // 2. Convert filters to a query string
//   const queryParams = new URLSearchParams(filters).toString();

//   // 3. Fetch updated HTML from the backend with filters
//   fetch(`/update_graph?${queryParams}`)
//     .then(response => response.text())
//     .then(html => {
//       // 4. Replace graph container content
//       graphContainer.innerHTML = html;

//       // 5. Execute any <script> tags in the returned HTML (for Plotly)
//       const scriptTags = graphContainer.querySelectorAll("script");
//       scriptTags.forEach(oldScript => {
//         const newScript = document.createElement("script");
//         if (oldScript.src) {
//           newScript.src = oldScript.src;
//         } else {
//           newScript.textContent = oldScript.textContent;
//         }
//         document.body.appendChild(newScript);
//         // Clean up to avoid script accumulation
//         document.body.removeChild(newScript);
//       });
//     })
//     .catch(error => {
//       console.error("Error updating graph:", error);
//     });
// }


    function updateMetrics(){
      $.ajax({
        url: '/get_metrics',
        method: 'GET',
        data: getCurrentFilters(),
        success: function(data){
          const rc = data.review_counts;
          const ms = data.metrics_summary;
          $('#metrics-summary').html(`
            <div class="stat-cards">
              <div class="stat-card"><div class="stat-value">${rc.total}</div><div class="stat-label">Total Queries</div></div>
              <div class="stat-card"><div class="stat-value">${rc.reviewed}</div><div class="stat-label">Reviewed</div></div>
              <div class="stat-card"><div class="stat-value">${rc.not_reviewed}</div><div class="stat-label">Not Reviewed</div></div>
            </div>
            <details>
              <summary style="cursor:pointer; color:#0b62d6; font-weight:600;">Breakdown</summary>
              <div id="breakdown">
                <div>${ms.overall}</div>
                <div>${ms.independent}</div>
                <div>${ms.response}</div>
                <div>${ms.query}</div>
                <div>${ms.urls}</div>
              </div>
            </details>
          `);
        }
      });
    }

    $("#update-table").on("click", function() {
      $.ajax({
        url: "/update_table",
        type: "POST",
        contentType: "application/json",
        success: function(response){
          window.location = "?page=1";
        },
        error: function(err){
          console.error("Update failed", err);
          alter("Something went wrong while updating.")
        }
      })
    })

    function handleIndependentChange(logId) {
      const indep = $(`select[name="is_independent_${logId}"]`).val() || "";

      const $resp = $(`select[name="response_review_${logId}"]`);
      const $qrev = $(`select[name="query_review_${logId}"]`);
      const $urev = $(`select[name="urls_review_${logId}"]`);

      if (indep === "No") {
        $resp.val("").prop('disabled', true);
        $qrev.val("").prop('disabled', true);
        $urev.val("").prop('disabled', true);
      } else {
        $resp.prop('disabled', false);
        $qrev.prop('disabled', false);
        $urev.prop('disabled', false);
      }
    }


    function updateLogEntry(logId){
      let indep = $(`select[name="is_independent_${logId}"]`).val() || "";
      let resp  = $(`select[name="response_review_${logId}"]`).val() || "";
      let qrev  = $(`select[name="query_review_${logId}"]`).val() || "";
      let urev  = $(`select[name="urls_review_${logId}"]`).val() || "";
      let notes = $(`tr[data-log-id='${logId}'] .notes-input`).val() || "";



      $.ajax({
        url: '/update_entry',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
          id: logId,
          is_independent_question: indep,
          response_review: resp,
          query_review: qrev,
          urls_review: urev,
          notes: notes
        }),
        success: function(data){
          if (data.status === 'success') {
            $(`tr[data-log-id='${logId}'] .last-updated-at`)
              .text(`${data.last_updated_at}`);
            $(`tr[data-log-id='${logId}'] .last-updated-by`)
              .text(`${data.last_updated_by}`);
            updateMetrics();
          }
        }
      });
    }
    
    $(document).ready(function(){
      $('#tool_filter, #independent_filter, #response_review_filter, #query_review_filter, #urls_review_filter, #review_status_filter')
        .select2({ placeholder: "Select", width: 'style' })

      $('#reset-filters').click(function(){
        $('#tool_filter').val("All").trigger('change');
        $('#independent_filter').val("All").trigger('change');
        $('#response_review_filter, #query_review_filter, #urls_review_filter').val(null).trigger('change');
        $('#review_status_filter').val("All").trigger('change');
      });

      $('select[name^="is_independent_"]').on('change', function(){
        const id = $(this).closest('tr').data('log-id');
        handleIndependentChange(id);
        updateLogEntry(id);
      });

      $('select[name^="response_review_"], select[name^="query_review_"], select[name^="urls_review_"]').on('change', function(){
        updateLogEntry($(this).closest('tr').data('log-id'));
      });


      $('.notes-input').on('change', function(){
        updateLogEntry($(this).closest('tr').data('log-id'));
      });
      
      // Build response previews + expand/collapse
      $('#logs-table-body tr').each(function () {
        const $row = $(this);
        const $full = $row.find('.response-full');
        const $preview = $row.find('.response-preview');
        const $btn = $row.find('.response-toggle');

        const text = ($full.text() || '').replace(/\s+/g, ' ').trim();

        if (text.length <= 240) {
          $preview.text(text);
          $btn.hide();
          return;
        }

        $preview.text(text.slice(0, 320) + '…');

        $btn.on('click', function () {
          const expanded = !$full.prop('hidden');
          if (expanded) {
            $full.prop('hidden', true);
            $preview.show();
            $btn.text('Expand');
          } else {
            $full.prop('hidden', false);
            $preview.hide();
            $btn.text('Collapse');
          }
        });
      });


      $('#download-all').click(function(){
        let file_type = $('input[name="download_type"]:checked').val();
        let f = getCurrentFilters();
        let qs = `?file_type=${file_type}`
               + `&start_date=${encodeURIComponent(f.start_date)}`
               + `&end_date=${encodeURIComponent(f.end_date)}`
               + `&view_by=${encodeURIComponent(f.view_by)}`
               + `&independent=${encodeURIComponent(f.independent)}`
               + `&review_status=${encodeURIComponent(f.review_status)}`;
        f.response_review.forEach(v=> qs+=`&response_review=${encodeURIComponent(v)}`);
        f.query_review.forEach(v=>    qs+=`&query_review=${encodeURIComponent(v)}`);
        f.urls_review.forEach(v=>     qs+=`&urls_review=${encodeURIComponent(v)}`);
        window.location.href = '/download_all' + qs;
      });
    });
  </script>
</body>
</html>